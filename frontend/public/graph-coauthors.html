<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="shortcut icon" href="./image/favicon.ico">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">

  <link rel="stylesheet" href="css/custom.css">

  <link rel="stylesheet" href="css/fakeLoader.css">

  <link rel="stylesheet" href="./css/font-awesome.min.css">

  <link rel="stylesheet" href="./css/nouislider.min.css">

  <script src="./js/d3.min.js"></script>
  <script src="./js/d3plus.full.min.js"></script>
  <script src="./js/jquery.min.js"></script>
  <script src="./js/angular.min.js"></script>
  <script src="./js/fakeLoader.min.js"></script>
  <script src="./js/nouislider.min.js"></script>
  <script src="./js/wNumb.js"></script>
  <script src="./js/utils.js"></script>
</head>

<body ng-app="">
  <div id="fakeLoader"></div>
  <div ng-include="'nav.html'"></div>

  <div class="container">
    <div class="row">
      <div class="col">
        <h1>Citation Web</h1>
        <p>A citation web for a base author. Up to 2 levels of co-authors is created (i.e. if the base author is A, capture
          up to C: B published the paper with A, and C published the paper with B, so A
          <- B <- C) </p>
      </div>
    </div>

    <div class="row">
      <div class="col col-12 col-md-8 order-2 order-md-1">
        <div id="graph"></div>
      </div>
      <div class="col col-12 col-md-4 order-1 order-md-2">
        <h5>Filtering</h5>

        <form id="filterForm">
          <div class="form-group">
            <label for="name">Base Author</label>
            <input class="form-control" id="name" placeholder="Author Name">
          </div>

          <h6>Level &#40;<span id="current-level">2</span>&#41;</h6>
          <div class="form-group row">
            <div class="col-12">
              <div id="slider"></div>
            </div>
          </div>

          <div class="form-group row">
            <div class="col-sm-10">
              <button type="submit" class="btn btn-sm btn-primary">Submit</button>
            </div>
          </div>

        </form>
      </div>
    </div>

    <!-- filter script -->
    <script>
      // init fakeloader
      initFakeLoader();

      // scripts for year slider
      const slider = document.getElementById('slider');

      noUiSlider.create(slider, {
        start: 2,
        padding: 0,
        range: {
          'min': 1,
          'max': 3
        },
        step: 1,
        format: wNumb({
          decimals: 0
        })
      });

      slider.noUiSlider.on('change', function () {
        const levelSliderValue = slider.noUiSlider.get();
        $("#current-level").text(levelSliderValue[0]);
      });

      // scripts for the input
      $("#filterForm").submit(() => {
        showFakeLoader();

        const currentLevel = slider.noUiSlider.get()[0];
        const name = $("#name").val();

        axios.get(
          `${API_HOST}/graph/co-Authors?levels=${currentLevel}&author=${name}`
        ).then(
          response => {
            updateVisualization(response.data);
            hideFakeLoader();
          });
      });

    </script>

  <!-- d3 Script -->
   <script>
      function updateVisualization(data) {
        $("#graph").empty();
        var visualization = d3plus.viz()
          .container("#graph")
          .type("network")
          .data(data.nodes)
          .edges(data.links)
          .edges({
            "arrows": 4,
            "strength": 1.4
          })
          .size({
            value: 5
          })
          .id("id")
          .width({
            value: $("#graph").width()
          })
          .height({
            value: 500
          })
          .labels({
            value: false
          })
          .tooltip({
            stacked: true,
            large: 500,
            fullscreen: true,
            html: function (id) {
              console.log(data.nodes);
              const paper = data.nodes.find(node => node.id === id);
              const viewUrl = googleScholarSearchUrl(paper.title);

              const htmlText =
                `<h6>${paper.title} (${paper.year})</h6>` +
                `<b>Author:</b> ${paper.authors.find(author => author.ids[0] === id).name}<br/>`;
                // +
                // `<b>Abstract:</b> ${paper.abstract}<br/><br/><a class="btn btn-secondary btn-sm" href="${viewUrl}" role="button" target="_blank">View</a>`;

              return htmlText;
            }
          })
          .draw();
      }

    </script>

    <!-- Optional JavaScript -->
    <script src="./js/axios.min.js"></script>
    <script src="./js/popper.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>

</body>

</html>
