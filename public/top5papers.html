<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">

  <link rel="stylesheet" href="css/custom.css">

  <link rel="stylesheet" href="css/fakeLoader.css">

  <script src="./js/d3.v4.min.js"></script>
  <script src="./js/jquery.min.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/angular.min.js"></script>
  <script src="./js/fakeLoader.min.js"></script>

</head>

<body ng-app="">
  <div id="fakeLoader"></div>
  <div ng-include="'nav.html'"></div>

  <div class="container">
    <h1>Top 5 Papers for Venue
      <span class="venue"></span>
    </h1>

    <div class="row">
      <div class="col">
        <div id="graphHorizontal"></div>
        <div class="toolTip"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-6">
        <div id="graphBubble"></div>
      </div>
      <div class="col-6">
        <div id="paper-display" class="col paper-display">
          <h2 class="paper-title"></h2>
          <p class="paper-abstract"></p>
          <p>
            <a class="paper-google"></a>
          </p>
        </div>

      </div>
    </div>
  </div>
  <!-- Params processing -->

  <script>
    /**
     * Parse url params and redirect if need be
     */
    var searchParams = new URLSearchParams(window.location.search)
    var venue = searchParams.get("venue")
    if (!venue) {
      var venue = prompt("Please enter venue", "arXiv");
      if (venue) {
        searchParams.set('venue', venue);
        window.location.search = searchParams.toString()
      }
    }

    $('.venue').html(venue)
  </script>

  <!-- d3 Script -->

  <script>
    $("#fakeLoader").fakeLoader({
      zIndex: "999",
      spinner: "spinner1",
      bgColor: "#2ecc71"
    });

    function displayPaper(paper) {
      location.href = "#paper-display";
      $paper = $(".paper-display")
      $paper.find(".paper-title")
        .html(paper.title)
        .css({
          'border-bottom': '1px solid black',
          'padding-bottom': '20px'
        });
      $paper.find(".paper-abstract")
        .html(paper.abstract);
      $paper.find(".paper-google")
        .attr("href", googleScholarSearchUrl(paper.title))
        .attr("target", "_blank")
        .html("Search on Google");
    }

    d3.json(API_HOST + "/top-papers?" + searchParams.toString(), function (error, data) {
      if (error) return showError(error)
      $("#fakeLoader").hide();

      const countMin = d3.min(data, paper => paper.inCitations.length);
      const countMax = d3.max(data, paper => paper.inCitations.length);

      /**
       * Bar chart
       */

      // set the dimensions and margins of the graph
      const barMargin = {
        top: 20,
        right: 70,
        bottom: 100,
        left: 70
      };

      const barWidth = 900 - barMargin.left - barMargin.right;
      const barHeight = 500 - barMargin.top - barMargin.bottom;
      const barPadding = 100;

      // set the ranges
      const x = d3.scaleBand()
        .range([0, barWidth])
        .padding(0.1);
      const y = d3.scaleLinear()
        .range([barHeight, 0]);

      const toolTip = d3.select(".toolTip");

      // append the svg object to the body of the page
      // append a 'group' element to 'svg'
      // moves the 'group' element to the top left margin
      const barSvg = d3.select("#graphHorizontal").append("svg")
        .attr("width", barWidth + barMargin.left + barMargin.right)
        .attr("height", barHeight + barMargin.top + barMargin.bottom)
        .append("g")
        .attr("transform", "translate(" + barMargin.left + "," + barMargin.top + ")");

      // scale the range of the data in the domains
      y.domain([0, countMax]);
      x.domain(data.map(paper => paper.title));

      // some processing

      data.forEach(function (paper) {
        const lines = [
          (paper.title),
          (paper.inCitations.length) + " citations",
          "Authors:",
          paper.authors.map(author => author.name).join(", ")
        ]
        paper.toolTipString = lines.join("<br>")
      }, this);

      var barDefaultFill = '#6baed6',
        barHoverFill = "#3182bd"
      // append the rectangles for the bar chart
      var bars = barSvg.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", paper => x(paper.title))
        .attr("width", x.bandwidth())
        .attr("y", barHeight)
        .attr("height", 0)
        .attr("fill", barDefaultFill)
        .attr('cursor', 'default')

      bars.transition().duration(1000)
        .attr("y", (paper) => y(paper.inCitations.length))
        .attr("height", calcBarHeight)

      bars
        .on("mousemove", (paper, index, rects) => {
          d3.select(rects[index])
            .attr('cursor', 'pointer')
            .style("fill", barHoverFill);

          toolTip
            .style("left", (d3.event.pageX - 100) + "px")
            .style("top", (d3.event.pageY - 100) + "px")
            .style("display", "inline-block")
            .html(paper.toolTipString);
        })
        .on("mouseout", (paper, index, rects) => {
          d3.select(rects[index])
            .attr("style", '');
          toolTip.style("display", "none");
        })
        .on("click", (paper) => {
          displayPaper(paper)
        })


      function calcBarHeight(paper) {
        return barHeight - y(paper.inCitations.length);
      }

      // add the x-axis
      barSvg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + barHeight + ")")
        .call(d3.axisBottom(x))
        .selectAll(".tick text")
        .call(wrapXText, x.bandwidth());

      // add the y-axis
      barSvg.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y))

      // add y-axis title
      barSvg.append("text")
        .attr("text-anchor", "middle")
        .attr("transform", "translate(" + (-barPadding / 2) + "," + (barHeight / 2) + ")rotate(-90)")
        .text("Number of Citations");

      // add x-axis title
      barSvg.append("text")
        .attr("text-anchor", "middle")
        .attr("transform", "translate(" + (barWidth / 2) + "," + (barHeight - (-barPadding * 1.5 / 2)) + ")")
        .text("Paper");

      /** 
       * Bubble Chart
       */
      const colors = d3.schemeCategory20c;
      const bubbleWidth = 500;
      const bubbleHeight = 500;

      const bubbleSvg = d3.select("#graphBubble")
        .append("svg")
        .attr("height", bubbleHeight)
        .attr("width", bubbleWidth)
        .append("g").attr("transform", "translate(" + bubbleWidth / 2 + "," + bubbleHeight / 2 + ")");

      const radiusScale = d3.scaleSqrt()
        .domain([countMin, countMax]).range([50, 80]);

      // the simulation is a collection of forces about where
      // we want the circles to go and how we want the circles to interact
      const simulation = d3.forceSimulation()
        .force("x", d3.forceX(0).strength(0.05))
        .force("y", d3.forceY(0).strength(0.05))
        .force("collide", d3.forceCollide(paper => radiusScale(paper.inCitations.length)));

      const circles = bubbleSvg.selectAll(".paper")
        .data(data)
        .enter().append("circle")
        .attr("class", "paper")
        .attr("r", paper => radiusScale(paper.inCitations.length))
        .attr("fill", (d, i) => colors[i])
        .on('mouseover', function () {
          d3.select(this).style('opacity', '0.5').attr('cursor', 'pointer')
        })
        .on('mouseleave', function () {
          d3.select(this).style('opacity', '1')
        })
        .on("click", displayPaper)
        .call(d3.drag()
          .on("start", dragStarted)
          .on("drag", dragged)
          .on("end", dragEnded));

      const labels = bubbleSvg.selectAll(".label")
        .data(data)
        .enter()
        .append("text")
        .attr("class", "label")
        .append("tspan")
        .text(function (d) {
          return d.inCitations.length;
        })
        .on("click", displayPaper);

      simulation.nodes(data)
        .on("tick", ticked);

      function ticked() {
        circles
          .attr("cx", function (d) {
            return d.x;
          })
          .attr("cy", function (d) {
            return d.y;
          });

        labels.attr("x", function (d) {
            return d.x;
          })
          .attr("y", function (d) {
            return d.y;
          })
      }

      function dragStarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragEnded(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    });
  </script>

  <style>
    #graphBubble .label:hover {
      text-decoration: bold;
      font-size: 20px;
      cursor: pointer;
    }

    #graphBubble .label {
      font-size: 15px;
    }
  </style>
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="./js/popper.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>
</body>

</html>
