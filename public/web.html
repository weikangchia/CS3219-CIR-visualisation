<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">

  <link rel="stylesheet" href="css/custom.css">

  <script src="./js/d3.v4.min.js"></script>
  <script src="./js/jquery-3.2.1.slim.min.js"></script>
  <script src="./js/utils.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
</head>

<body ng-app="">
  <div ng-include="'nav.html'"></div>

  <div class="container">
    <h1>Citation Web</h1>

    <div class="row">
      <div class="col">
        <div id="graph"></div>
      </div>
    </div>
  </div>

  <!-- d3 Script -->

  <script>
    const data = {
      "nodes": [{
          "id": "1",
          "title": "ABC",
          "level": 1
        },
        {
          "id": "2",
          "title": "DEF",
          "level": 2
        },
        {
          "id": "3",
          "title": "GHI",
          "level": 2
        },
        {
          "id": "4",
          "title": "JKL",
          "level": 3
        }
      ],
      "links": [{
        "source": "1",
        "target": "2"
      }, {
        "source": "1",
        "target": "3"
      }, {
        "source": "3",
        "target": "4"
      }]
    };

    const width = 1000;
    const height = 600;

    const svg = d3.select('#graph').append('svg')
      .attr('width', width).attr('height', height);

    const simulation = d3.forceSimulation()
      .force("link", d3.forceLink().id(function (d) {
        return d.id;
      }))
      .force("charge", d3.forceManyBody()
        .strength(-2000))
      .force("center", d3.forceCenter(width / 2, height / 2));

    const link = svg.append("g")
      .attr("class", "links")
      .selectAll("line")
      .data(data.links)
      .enter().append("line");

    const node = svg.append("g")
      .attr("class", "nodes")
      .selectAll("circle")
      .data(data.nodes)
      .enter().append("circle")
      .attr("r", 10)
      .attr("fill", function (d) {
        console.log(d.level);
        if (d.level === 1) {
          return "green";
        } else if (d.level === 2) {
          return "orange";
        } else {
          return "red";
        }
      })
      .call(d3.drag()
        .on("start", dragStarted)
        .on("drag", dragged)
        .on("end", dragEnded));

    const label = svg.selectAll(".title")
      .data(data.nodes)
      .enter()
      .append("text")
      .attr("class", "label")
      .text(function (d) {
        return d.title;
      });

    simulation
      .nodes(data.nodes)
      .on("tick", ticked);

    simulation.force("link")
      .links(data.links);

    svg.append("svg:defs").selectAll("marker")
      .data(["end"])
      .enter().append("svg:marker")
      .attr("id", String)
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 25)
      .attr("refY", 0)
      .attr("markerWidth", 5)
      .attr("markerHeight", 5)
      .attr("orient", "auto")
      .append("svg:path")
      .attr("d", "M0,-5L10,0L0,5");

    function ticked() {
      link
        .attr("x1", function (d) {
          return d.source.x;
        })
        .attr("y1", function (d) {
          return d.source.y;
        })
        .attr("x2", function (d) {
          return d.target.x;
        })
        .attr("y2", function (d) {
          return d.target.y;
        })
        .attr("marker-end", "url(#end)");

      node
        .attr("cx", function (d) {
          return d.x;
        })
        .attr("cy", function (d) {
          return d.y;
        });

      label
        .attr("x", function (d) {
          return d.x;
        })
        .attr("y", function (d) {
          return d.y - 20;
        });
    }

    function dragStarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragEnded(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  </script>


  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="./js/jquery-3.2.1.slim.min.js"></script>
  <script src="./js/popper.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>
</body>

</html>
